<?php $nav = "FUNCTION"; $side = "INDEX"; $sideTop = "PRODUCT";?>
<include file="Public:head"/>
<link type="text/css" href="{pigcms::RES}/css/Product_set.css" rel="stylesheet"/>
<!--<link type="text/css" href="/tpl/static/xhedit/demo/common.css" rel="stylesheet"/>-->
<style type="text/css">
	.btnMap {
		width:50px !important;
		background:transparent url(/tpl/static/xhedit/demo/googlemap/map.gif) no-repeat center center;
	}
	.btnCode {                     
		background:transparent url(/tpl/static/xhedit/demo/prettify/code.gif) no-repeat 16px 16px;
		background-position:2px 2px;
	}
</style>
<script type="text/javascript" src="/tpl/static/xhedit/jquery/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/tpl/static/xhedit/xheditor-1.2.1.min.js"></script>
<script type="text/javascript" src="/tpl/static/xhedit/xheditor_lang/zh-cn.js"></script>
<script type="text/javascript" src="/tpl/static/xhedit/xheditor_plugins/showdown.js"></script>
<script type="text/javascript" src="/tpl/static/xhedit/xheditor_plugins/htmldomparser.js"></script>
<script type="text/javascript" src="/tpl/static/xhedit/xheditor_plugins/html2markdown.js"></script>

<script src="{pigcms::STATICS}/kindeditor/kindeditor.js" type="text/javascript"></script>
<script src="{pigcms::STATICS}/kindeditor/lang/zh_CN.js" type="text/javascript"></script>
<script src="{pigcms::STATICS}/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
<script src="/tpl/static/artDialog/jquery.artDialog.js?skin=default"></script>
<script src="/tpl/static/artDialog/plugins/iframeTools.js"></script>
<script src="/tpl/static/upyun.js" type="text/javascript"></script>
<script type="text/javascript" src="{pigcms::RES}/js/formCheck/formcheck.js"> </script>
<script type="text/javascript">
var n='{pigcms:$n}';
var is=true;
$(function(){
		$("#catid").change(function(){
			if($(this).children('option:selected').val()==0){
				is=false;
				$(this).next().show();
			}else{
				is=true;
				$(this).next().hide();
			}
		});
	});
var markdownConverter = new Showdown.converter();
function Md2HTML(md){
	return markdownConverter.makeHtml(md);
}
function HTML2Md(html){
	var md = HTML2Markdown(html);
    md = md.replace(/&(lt|gt|amp|quot);/ig,function(all, t){
        return {'lt':'<','gt':'>','amp':'&','quot':'"'}[t.toLowerCase()];
    });
    return md;
}
function pageInit()
{   
    $.extend(XHEDITOR.settings,{shortcuts:{'ctrl+enter':submitForm}});
	

	var markdownCSS = '<style>*{margin:0;padding:0;}p {margin:1em 0;line-height:1.5em;}table {font-size:inherit;font:100%;margin:1em;}table th{border-bottom:1px solid #bbb;padding:.2em 1em;}table td{border-bottom:1px solid #ddd;padding:.2em 1em;}input[type=text],input[type=password],input[type=image],textarea{font:99% helvetica,arial,freesans,sans-serif;}select,option{padding:0 .25em;}optgroup{margin-top:.5em;}img{border:0;max-width:100%;}abbr{border-bottom:none;}a{color:#4183c4;text-decoration:none;}a:hover{text-decoration:underline;}a code,a:link code,a:visited code{color:#4183c4;}h2,h3{margin:1em 0;}h1,h2,h3,h4,h5,h6{border:0;}h1{font-size:170%;border-bottom:4px solid #aaa;padding-bottom:.5em;margin-top:1.5em;}h1:first-child{margin-top:0;padding-top:.25em;border-top:none;}h2{font-size:150%;margin-top:1.5em;border-bottom:4px solid #e0e0e0;padding-bottom:.5em;}h3{margin-top:1em;}hr{border:1px solid #ddd;}ul{margin:1em 0 1em 2em;}ol{margin:1em 0 1em 2em;}ul li,ol li{margin-top:.5em;margin-bottom:.5em;}ul ul,ul ol,ol ol,ol ul{margin-top:0;margin-bottom:0;}blockquote{margin:1em 0;border-left:5px solid #ddd;padding-left:.6em;color:#555;}dt{font-weight:bold;margin-left:1em;}dd{margin-left:2em;margin-bottom:1em;}pre{margin-left:2em;border-left:3px solid #CCC;padding:0 1em;}</style>';
	var plugins={
	
		map:{c:'btnMap',t:'插入Google地图',e:function(){
			var _this=this;
			_this.saveBookmark();
			_this.showIframeModal('Google 地图','/tpl/static/xhedit/demo/googlemap/googlemap.html',function(v){
				_this.loadBookmark();
				_this.pasteHTML('<img src="'+v+'" />');
			},538,404);
		}}
	};
	$.extend(XHEDITOR.settings,{shortcuts:{'ctrl+enter':submitForm}});//修改默认设置
	   editor=$('#elm1').xheditor({upLinkUrl:"{pigcms::U('Upload2/add')}",upImgUrl:"{pigcms::U('Upload2/add')}",upFlashUrl:"{pigcms::U('Upload2/add')}",upMediaUrl:"{pigcms::U('Upload2/add')}",localUrlTest:/^https?:\/\/[^\/]*?(xheditor\.com)\//i,remoteImgSaveUrl:"{pigcms::U('Upload2/add')}",emots:{
		msn:{name:'MSN',count:40,width:22,height:22,line:8},
		pidgin:{name:'Pidgin',width:22,height:25,line:8,list:{smile:'微笑',cute:'可爱',wink:'眨眼',laugh:'大笑',victory:'胜利',sad:'伤心',cry:'哭泣',angry:'生气',shout:'大骂',curse:'诅咒',devil:'魔鬼',blush:'害羞',tongue:'吐舌头',envy:'羡慕',cool:'耍酷',kiss:'吻',shocked:'惊讶',sweat:'汗',sick:'生病',bye:'再见',tired:'累',sleepy:'睡了',question:'疑问',rose:'玫瑰',gift:'礼物',coffee:'咖啡',music:'音乐',soccer:'足球',good:'赞同',bad:'反对',love:'心',brokenheart:'伤心'}},
		ipb:{name:'IPB',width:20,height:25,line:8,list:{smile:'微笑',joyful:'开心',laugh:'笑',biglaugh:'大笑',w00t:'欢呼',wub:'欢喜',depres:'沮丧',sad:'悲伤',cry:'哭泣',angry:'生气',devil:'魔鬼',blush:'脸红',kiss:'吻',surprised:'惊讶',wondering:'疑惑',unsure:'不确定',tongue:'吐舌头',cool:'耍酷',blink:'眨眼',whistling:'吹口哨',glare:'轻视',pinch:'捏',sideways:'侧身',sleep:'睡了',sick:'生病',ninja:'忍者',bandit:'强盗',police:'警察',angel:'天使',magician:'魔法师',alien:'外星人',heart:'心动'}}
	},plugins:plugins,loadCSS:'<style>pre{margin-left:2em;border-left:3px solid #CCC;padding:0 1em;}</style>',shortcuts:{'ctrl+enter':submitForm}});
}
function submitForm(){$('#frmDemo').submit();}
$(pageInit);


var editor;
KindEditor.ready(function(K) {
editor = K.create('#intro', {
resizeType : 1,
allowPreviewEmoticons : false,
allowImageUpload : false,
items : [
'source','undo','clearhtml','hr',
'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
'insertunorderedlist', '|', 'emoticons', 'image','link', 'unlink','baidumap','lineheight','table','anchor','preview','print','template','code','cut']
});

});

function showChildCats(value){
	$("#catid").html('<option value="0">请选择类别...</option>');
	if(value==0){
		document.getElementById('catid').disabled=true;
	}else{
		$.ajax({
			url: $('#catUrl').attr("value")+'&parentid='+value,
			success: function( data ) {
				document.getElementById('catid').disabled=false;
				$("#catid").html($("#catid").html()+data);
			}
		});
	}
}
function toDecimal(x) {  
            var f = parseFloat(x);  
            if (isNaN(f)) {  
                return;  
            }  
            f = Math.round(x*10)/10;  
            return f;  
        }  
<!-- function calDiscount(){
	//var price=$('#price').attr('value');
//	var oprice=$('#oprice').attr('value');
//	if(oprice!=0&&oprice!=''){
	//	var dis=oprice-price;
	//	var discount=10-toDecimal((dis/oprice)*10);
//	}else{
//		discount=10;
//	}
	//$('#discount').attr('value',discount);
//} 

// $(function(){
// 	$("#form").valid([
// 	{ name:"name",simple:"名称",require:true},
// 	{ name:"keyword",simple:"关键词",require:true},
// 	//{ name:"catid",message:"请选择类别",require:true},
// 	{ name:"price",type:"currency",message:"价格输入不正确"},
// 	{ name:"oprice",type:"currency",message:"原价输入不正确"},
// 	//{ name:"fakemembercount",type:"int",message:"报名基数只能填写整数或0"}
		
// 	],true,true);
// })
</script>
<!-- <script src="{pigcms::RES}/js/vote.js"></script> -->
<script src="{pigcms::RES}/js/top.js"></script>
<div class="container main">
<div class="row">
<include file="Product:left"/>    
     <!--right--begain-->
          <div class="col-md-10 main">
            	 <ol class="breadcrumb">
              <li><a href="{pigcms::U('Product/index',array('token'=>$token))}">微商城</a></li>
              <li><a href="{pigcms::U('Product/index',array('token'=>$token))}">商城管理</a></li>
              <li><a href="{pigcms::U('Product/index',array('token'=>$token))}">商品管理</a></li>
              <li class="active"><if condition="$_GET['id']">编辑<else />添加</if>商品</li>
            </ol>
           	  <div class="panel panel-success">
            		<!-- <p class="rightTop">
                	<a href="{pigcms::U('Function/index',array('token'=>$token,'id'=>session('wxid')))}"  class="back">回到首页</a>
                    <a href="" onclick="reloadMainFrame();" class="new">刷新</a>
              </p>            
              <p class="artiEdit"><span class="big"><if condition="$isDining neq 1">商品<else/>菜品</if>设置 </span><a href="javascript:history.go(-1);" class="addListX">返回</a></p> -->
              <div class="panel-heading">
              	<h3 class="panel-title"><if condition="$isDining neq 1">商品<else/>菜品</if>设置</h3>
              </div>
              <div class="panel-body">
               <form class="form" method="post" action="" enctype="multipart/form-data" id="form" > 
				<if condition="$isUpdate eq 1">
				<input type="hidden" name="id" value="{pigcms:$set.id}" />
				</if>			
				<input type="hidden" name="storeid" value="1" >
				<div class="keyWord">
                    <span class="Tex">所属类别：</span>				
                    <select id="catid" name="catid">
							<volist name="options" id="option">
								<option value="{pigcms:$option['id']}" <if condition="$catid eq $option['id']">selected="selected"</if>>{pigcms:$option['name']}</option>
							</volist>
                    </select>
                  <!-- <select id="catid" name="catid"><option value="0" selected="selected">请选择分类...</option>{pigcms:$catsOptions}</select> -->
                  <!-- <small class="text-danger" style="display:none">不能选择顶级分类,请重新选择!</small> -->
                </div>
                <p class="same">
                    <span class="Tex">商品名称：</span>
                    <input type="text" name="name" value="{pigcms:$set.name}" class="circle"/>
                </p>
				  <!-- <p class="same">
                    <span class="Tex">商品简介：</span>
                    <input type="text" name="name" value="{pigcms:$set.name}" class="circle"/>
                </p> -->
				 <!--  <div class="keyWord">
                    <tr>
						<td class="label">设置为:</td>
						<td><if condition="$set[ 'jinpin' ] neq on" ><input type="checkbox" name="jinpin"> 精品<else/><input type="checkbox" name="jinpin" checked="true"> 精品</if><if condition="$set[ 'news' ] neq on" ><input type="checkbox" name="news" >新品<else/><input type="checkbox" name="news" checked="true">新品</if><if condition="$set[ 'cuxiao' ] neq on" ><input type="checkbox" name="cuxiao" >推荐<else/><input type="checkbox" name="cuxiao" checked="true">推荐</if></td>
							</tr>
								</div> -->
					<!-- <div class="keyWord">
                    <tr>
						<td class="label">是否首页显示:</td>
						<td><if condition="$set[ 'is_index' ] neq on" ><input type="checkbox" name="is_index" id="index">（首页最多设置俩条显示）<else/><input type="checkbox" name="is_index" id="index" checked="true">（首页最多设置俩条显示）</if></td>
							</tr>
								</div>	 -->		
				<!--  <p class="same" style="display:none" id="jinpinurl">
                    <span class="Tex">精品图片：</span>
                    <input type="text" id='jinpurl' name="jinpinurl" value="{pigcms:$set.logourl}"  class="circle"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="a_upload">上传</a>
                </p>
				 <p class="same" style="display:none" id="newsurl">
                    <span class="Tex">新品图片：</span>
                    <input type="text" id='newsurl' name="newsurl" value="{pigcms:$set.logourl}"  class="circle"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="a_upload">上传</a>
                </p>
				 <p class="same" style="display:none" id="tuijianurl">
                    <span class="Tex">推荐图片：</span>
                    <input type="text" id='tuijianurl' name="tuijianurl" value="{pigcms:$set.logourl}"  class="circle"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="a_upload">上传</a>
                </p>	 -->
                <p class="same">
                    <span class="Tex">商品原价：</span>
                   <input type="text" id="oprice" onchange="calDiscount();" name="oprice" value="{pigcms:$set.oprice}" class="Scircle"/>元
                </p>
                <p class="same">
                    <span class="Tex">活动价格：</span>
                    <input type="text" id="price" onchange="calDiscount();" name="price" value="{pigcms:$set.price}"   class="Scircle"/>元 <small class="text-danger"></small>
                </p>
				 <p class="same">
                    <span class="Tex">活动折扣：</span>
                    <input type="text"  name="discount1" value="" class="Scircle" disabled />折
                    <input type="hidden" name="discount" value="" />
                </p>
    <!--             <p class="same">
                    <span class="Tex">关键词：</span>
                    <input type="text" name="keyword" value="{pigcms:$set.keyword}" class="Scircle"/>
                </p> -->
				 <p class="same">
                    <span class="Tex">运费方式：</span>
					<select id="catid" name="freight">
					<option value="1">卖家包邮</option>
					<option value="0">买家包邮</option>
					</select>
                </p>
				<!--  <p class="same">
                    <span class="Tex">商品颜色：</span>
                    <input type="text" name="color" value="{pigcms:$set.color}" class="Scircle"/>
                </p>	 -->
                <p class="same">
                    <span class="Tex">是否上架：</span>
                    <input type="radio" name="putaway" value="1" <if condition="$putaway">checked='checked'</if> />是
                    <input type="radio" name="putaway" value="0" <if condition="$putaway eq 0">checked='checked'</if> />否
                </p>
				<!-- <p> <span class="Tex"><span style="color:red;">*</span>商品规格：</span></p>
				<div id="vote_options" style="margin-left:140px;"> 
					<foreach name="etalon" item="et" key='key'>
						<p class="same">
							<input type="text" placeholder="规格" class="circle etalon" id="vote_option_{pigcms:$key+1}" name="" value="{pigcms:$etalon[$key]}"/>
						</p>
					</foreach>     
						<div class="same" id="vote_add" >
							<input type="button" class="btn btn-success btn-sm" value="添加" onclick="_vote._add();"/>
							<div class="clear"></div>
						</div>	

					</div> -->
					<p> <span class="Tex">商品规格/数量：</span></p>
								<div class="row norms" style="margin:10px 140px">
									<input type="text" class="Scircle" placeholder="规格" value="{pigcms:$etaFirst[0]}" />
									<input type="text" class="Scircle" placeholder="数量" style="width:50px" value="{pigcms:$etaFirst[1]}" onblur="count.call(this)">
								</div>
								<if condition="$etalons neq ''">
									<volist name="etalons" id="etalon">
										<div class="row norms" style="margin:10px 140px">
											<input type="text" class="Scircle" placeholder="规格" value="{pigcms:$etalon[0]}" />
											<input type="text" class="Scircle" placeholder="数量" style="width:50px" value="{pigcms:$etalon[1]}" onblur="count.call(this)">
										</div>
									</volist>
								</if>
								<small class="text-danger" style="padding:5px 140px;display:none"></small>
								<div class="row" style="margin:10px 140px">
									<input type="button" class="btn btn-success btn-sm" id="vote_add" value="增加" />
									<input type="button" class="btn btn-danger btn-sm" id="vote_del" value="删除" />
								</div>
				<p class="same">
                    <span class="Tex">库存数量：</span>
                    <input type="text" name="repertory" value="{pigcms:$set.repertory}" class="Scircle" readonly />
                </p>

					<p class="same">
                    <span class="Tex">商品图片：</span>
                    <input type="text"  name="index_logo" value="{pigcms:$set.index_logo}"  class="circle" id="index_logo" placeholder="图片规格140*140"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="btn btn-info btn-sm"><span class="glyphicon glyphicon-upload"></span> 上传</a>
					</p>
					<p> <span class="Tex">商品展示图片：</span></p>
					<div id="vote_logo" style="margin-left:140px;">
						<p class="same">		
						<input type="text" id='url_1' name="" value="{pigcms:$logourl[0]}" class="circle lurl" placeholder="图片规格200*200"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="btn btn-info btn-sm" ><span class="glyphicon glyphicon-upload"></span> 上传</a>
						</p>
						<p class="same">		
						<input type="text" id='url_2' name="" value="{pigcms:$logourl[1]}" class="circle lurl" placeholder="图片规格200*200"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="btn btn-info btn-sm"><span class="glyphicon glyphicon-upload"></span> 上传</a>
						</p>
						<p class="same">		
						<input type="text" id='url_3' name="" value="{pigcms:$logourl[2]}" class="circle lurl" placeholder="图片规格200*200"/><a href="###" onclick="upyunPicUpload($(this).prev().attr('id'),'pic',700,420,'qtclsw1382672973')" class="btn btn-info btn-sm"><span class="glyphicon glyphicon-upload"></span> 上传</a>
						</p>
						<!-- <div class="same" id="vote_logoadd" >
							<input type="button" class="btn btn-success btn-sm" value="添加" onclick="_vote._logoadd()"/>
							<div class="clear"></div>
						</div>	 -->
					</div>	
                <div style="margin-top:20px;height:245px;">
                <span class="Tex">商品详细：</span>
                <div class="detailTex">               
                    <textarea class="fontBox" id="elm1" name="intro">{pigcms:$set.intro}</textarea>
					<!-- <textarea name="intro" class="form-control" style="width:100%;height:180px">{pigcms:$set.intro}</textarea> -->
				</div>
                </div>
                       <if condition="$isDining neq 1"><input type="hidden" value="0" name="dining" /><else/><input type="hidden" value="1" name="dining" /></if>
                <input type="hidden" value="" name="etalon" id="hid" />
				<input type="hidden" value="" name="logourl" id="lhi"/>
				</div>
				<div class="panel-footer" style="text-align:right">
						<input type="button" value="保存" class="btn btn-success" id="sub"/>
						<a href="{pigcms::U('Product/index',array('token'=>$token))}" class="btn btn-link">取消</a>
				</div>
           </form>
               </div>
               </div>
            </div>        				
            </div>        				
 </div>
 <script>
  function count(){
 		var v=0;
 			$('.norms').each(function(i){
 				v=parseInt(v)+parseInt($('.norms').eq(i).find('input:eq(1)').val());
 			});
 			$('input[name="repertory"]').val(v);
 			if(isNaN($('input[name="repertory"]').val())){
 				$('input[name="repertory"]').val('无法计算')
 			}
 	}
 	$(function(){
 		count();
 		zhekou();
 		 		$('#vote_add').click(function(){
 		 			var iH=$('.norms').innerHeight();
 		 			var iLen=$('.norms').size();
 		 			var sNorms='<div class="row norms"  style="margin:10px 140px;height:33px;display:none;">\
 										<input type="text" class="Scircle" placeholder="规格" />\
 										<input type="text" class="Scircle" placeholder="数量" style="width:50px" onblur="count.call(this)">\
 									</div>';
 		 			$('.norms').eq(iLen-1).after(sNorms);
 		 			$('.norms').eq($('.norms').size()-1).show(300);
 		 		})
 		 		$('#vote_del').click(function(){
 		 			var iLen=$('.norms').size();
 		 			if(iLen>1){
 			 			$('.norms').eq($('.norms').size()-1).hide(300,function(){
 				 			$('.norms').eq($('.norms').size()-1).remove();
 		 			count();
 			 			});
 		 			}else{
 		 				return;
 		 			}
 		 		});
 		 		$("#sub").click(function(){
 		 			var etalon='';
 		 			$('.norms').each( function(index) {
 		 				 if($('.norms').eq(index).find('input:eq(0)').val() && $('.norms').eq(index).find('input:eq(1)').val()){
 		 				 	$('.norms').eq($('.norms').size()-1).next().hide();
 		 				 	if(/^([1-9])[0-9]*$/.test($('.norms').eq(index).find('input:eq(1)').val())){
 		 				 		$('.norms').eq($('.norms').size()-1).next().hide();
 		 				 		etalon +=$('.norms').eq(index).find('input:eq(0)').val()+','+$('.norms').eq(index).find('input:eq(1)').val()+'^';
 		 				 	}else{
 		 				 		$('.norms').eq($('.norms').size()-1).next().show();
 		 				 		$('.norms').eq($('.norms').size()-1).next().html('数量必须是大于0的整数');
 		 				 		alert('数量必须是大于0的整数');
 		 				 	}
 		 				 }else{
 		 				 	$('.norms').eq($('.norms').size()-1).next().show();
 		 				 	$('.norms').eq($('.norms').size()-1).next().html('规格数量不能为空');
 		 				 	alert('规格数量不能为空');
 		 				 }
 		 			});
 		 			var arr=[];
 		 			arr=etalon.split('^');
 		 			if($('.norms').size()==arr.length-1){
 		 				var logourl='';
 		 				$('.lurl').each( function(index) {
 		 					if($('.lurl').eq(index).val())
 		 						logourl +=$('.lurl').eq(index).val()+'^';
 		 				});
 		 				$('#lhi').val(logourl);
 		 				$('#hid').val(etalon);
 		 				if(parseInt($('#oprice').val())<parseInt($('#price').val())){
 		 					$("input[name='price']").next().html('活动价格必须小于等于原价');
 		 					alert('活动价格必须小于等于原价');
 		 					location="#"
 		 				}else{
 		 					
 		 				$('#form').submit();
 		 				}
 		 			}
 		 		});
$('#oprice').blur(function(){
	zhekou();
});
$("#price").blur(function(){zhekou();});
 	});
function zhekou(){

	$('input[name="discount1"]').val(toDecimal($('#price').val()/$('#oprice').val()*10));
	if($('input[name="discount1"]').val()=='Infinity'){
		$('input[name="discount1"]').val('')
	}
	if($('input[name="discount1"]').val()==10){
		$('input[name="discount1"]').val('');
	}
	if($('input[name="discount1"]').val()==0){
		$('input[name="discount1"]').val('');
	}
	$('input[name="discount"]').val($('input[name="discount1"]').val());
}
function toDecimal(x) {  
            var f = parseFloat(x);  
            if (isNaN(f)) {  
                return;  
            }  
            f = Math.round(x*10)/10;  
            return f;  
        } 
 </script>
<include file="Public:footer"/>